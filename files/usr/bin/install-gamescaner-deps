#!/bin/bash

set -e

# Define the fixed file
FIXED_REQUIREMENTS_FILE="/usr/share/dev-work/gamescanner-dev-env.txt"

# Find all requirements.in files and store them in an array
REQUIREMENTS_DOT_IN_FILES=$(find . -name requirements.in)

# Temporary file to store combined requirements
TEMP_REQUIREMENTS_FILE=$(mktemp)

echo "Updating and combining requirements.in files with $FIXED_REQUIREMENTS_FILE: ${REQUIREMENTS_DOT_IN_FILES[*]}"

# Install and update pur if necessary
pip install --upgrade --quiet pur 2>/dev/null

# Process each requirements.in file
for requirements_file in ${REQUIREMENTS_DOT_IN_FILES[@]}; do
  # Update the requirements.in file using pur
  pur -r "${requirements_file}"
  
  # Append the updated contents to the temporary requirements file
  cat "${requirements_file}" >> "$TEMP_REQUIREMENTS_FILE"
  echo -e "\n" >> "$TEMP_REQUIREMENTS_FILE"  # Add a newline between files
done

# Append the contents of the fixed file to the temporary requirements file
cat "$FIXED_REQUIREMENTS_FILE" >> "$TEMP_REQUIREMENTS_FILE"
echo -e "\n" >> "$TEMP_REQUIREMENTS_FILE"  # Add a newline after the fixed file

# Remove duplicate lines while preserving order
awk '!seen[$0]++' "$TEMP_REQUIREMENTS_FILE" > requirements.txt

# Clean up temporary file
rm "$TEMP_REQUIREMENTS_FILE"

echo "Combined and updated requirements.txt created, including $FIXED_REQUIREMENTS_FILE."

